<!doctype html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>NAC Internal Auditor AI (Website)</title>
    <meta name="description" content="Simple rule-based internal audit website for NAC - upload CSV and run automated checks" />
    <!-- Tailwind Play CDN for quick styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React + ReactDOM + Babel (for single-file JSX convenience) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
  </head>
  <body class="bg-slate-50 min-h-screen p-6">
    <div id="root" class="max-w-6xl mx-auto"></div><!-- App JSX (will be transpiled by Babel in-browser) -->
<script type="text/babel">
  const { useState } = React;

  function parseCSV(text) {
    const lines = text
      .split(/\r?\n/)
      .map((l) => l.trim())
      .filter((l) => l.length > 0);
    if (lines.length === 0) return [];
    const parts = lines[0].split(",").map((h) => h.trim());
    const hasHeader = parts.some((p) => /[a-zA-Z]/.test(p));
    let headers = [];
    let dataStart = 0;
    if (hasHeader) {
      headers = parts;
      dataStart = 1;
    } else {
      const cols = parts.length;
      headers = Array.from({ length: cols }, (_, i) => `col_${i + 1}`);
      dataStart = 0;
    }
    const out = [];
    for (let i = dataStart; i < lines.length; i++) {
      const vals = lines[i].split(",").map((v) => v.trim());
      const obj = {};
      for (let j = 0; j < headers.length; j++) obj[headers[j]] = vals[j] ?? "";
      out.push(obj);
    }
    return out;
  }

  function runAudit(dataRows, auditName) {
    const findings = [];
    const keys = dataRows.length > 0 ? Object.keys(dataRows[0]).map(k => k.toLowerCase()) : [];
    const hasAccount = keys.some(k => k.includes('account') || k.includes('code'));
    const hasAmount = keys.some(k => k.includes('amount') || k.includes('value') || k.includes('total'));
    const hasReceipt = keys.some(k => k.includes('receipt') || k.includes('invoice'));
    const hasDate = keys.some(k => k.includes('date'));
    const hasEmployee = keys.some(k => k.includes('employee') || k.includes('staff') || k.includes('name'));

    if (!hasDate) findings.push({ area: 'Documentation', issue: 'No date column found', risk: 'High', recommendation: 'Include transaction dates for every record.' });
    if (!hasAmount) findings.push({ area: 'Documentation', issue: 'No amount column detected', risk: 'High', recommendation: 'Include monetary amounts (Amount/Value/Total) for audit accuracy.' });
    if (!hasReceipt) findings.push({ area: 'Supporting Documents', issue: 'Receipts/invoice column not found', risk: 'Medium', recommendation: 'Attach receipts or invoice numbers for each expense record.' });

    const acquitKey = Object.keys(dataRows[0] || {}).find(k => k.toLowerCase().includes('acquit'));
    const issueDates = Object.keys(dataRows[0] || {}).find(k => k.toLowerCase().includes('issue') || k.toLowerCase().includes('given') || k.toLowerCase().includes('date'));
    if (acquitKey && issueDates) {
      const late = dataRows.filter(r => {
        const d1 = new Date(r[issueDates]);
        const d2 = new Date(r[acquitKey]);
        if (isNaN(d1) || isNaN(d2)) return false;
        const diffDays = Math.round((d2 - d1) / (1000*60*60*24));
        return diffDays > 14;
      });
      if (late.length > 0) findings.push({ area: 'Imprest Acquittal', issue: `Found ${late.length} acquittal(s) > 14 days`, risk: 'Medium', recommendation: 'Enforce 14-day acquittal policy and automated reminders.' });
    }

    if (hasReceipt) {
      const receiptKey = Object.keys(dataRows[0]).find(k => k.toLowerCase().includes('receipt') || k.toLowerCase().includes('invoice'));
      const missing = dataRows.filter(r => !r[receiptKey]);
      if (missing.length > 0) findings.push({ area: 'Receipts', issue: `${missing.length} records missing receipts`, risk: 'High', recommendation: 'Require receipt upload before approval.' });

      const map = {};
      const dups = [];
      dataRows.forEach(r => {
        const v = (r[receiptKey] || '').toString().trim();
        if (!v) return;
        map[v] = (map[v] || 0) + 1;
        if (map[v] === 2) dups.push(v);
      });
      if (dups.length > 0) findings.push({ area: 'Invoice/Receipt Duplicates', issue: `${dups.length} duplicate receipt/invoice numbers found`, risk: 'High', recommendation: 'Block duplicate invoice numbers at upload and investigate duplicates.' });
    }

    if (hasAmount) {
      const amountKey = Object.keys(dataRows[0]).find(k => k.toLowerCase().includes('amount') || k.toLowerCase().includes('value') || k.toLowerCase().includes('total'));
      const nums = dataRows.map(r => parseFloat(String(r[amountKey]).replace(/[^0-9.-]/g, ''))).filter(n => !isNaN(n));
      if (nums.length > 3) {
        const avg = nums.reduce((a,b) => a+b, 0)/nums.length;
        const variance = nums.reduce((s,x)=>s+(x-avg)*(x-avg),0)/nums.length;
        const sd = Math.sqrt(variance || 1);
        const outliers = nums.filter(n => Math.abs(n - avg) > 3 * sd);
        if (outliers.length > 0) findings.push({ area: 'Amount Anomalies', issue: `${outliers.length} potential outlier amounts`, risk: 'Medium', recommendation: 'Review unusually large or small transactions.' });
      }
    }

    const reqKey = Object.keys(dataRows[0] || {}).find(k => k.toLowerCase().includes('request') || k.toLowerCase().includes('requested_by') || k.toLowerCase().includes('requester'));
    const apprKey = Object.keys(dataRows[0] || {}).find(k => k.toLowerCase().includes('approved') || k.toLowerCase().includes('approved_by') || k.toLowerCase().includes('approver'));
    if (reqKey && apprKey) {
      const sod = dataRows.filter(r => (r[reqKey] || '').toString().trim() && (r[apprKey] || '').toString().trim() && (r[reqKey] || '').toString().trim() === (r[apprKey] || '').toString().trim());
      if (sod.length > 0) findings.push({ area: 'Segregation of Duties', issue: `${sod.length} records show requester = approver`, risk: 'High', recommendation: 'Ensure separation of requester and approver roles.' });
    }

    if (findings.length === 0) findings.push({ area: 'General', issue: 'No issues detected by automated rules', risk: 'Low', recommendation: 'Continue current controls and schedule periodic reviews.' });

    const severityCount = { High: 0, Medium: 0, Low: 0 };
    findings.forEach(f => { severityCount[f.risk] = (severityCount[f.risk] || 0) + 1; });

    return {
      title: auditName || 'NAC Auto-Audit',
      generated_at: new Date().toISOString(),
      total_records: dataRows.length,
      findings_count: findings.length,
      severity: severityCount,
      findings,
      recommendations: findings.map(f => ({ area: f.area, recommendation: f.recommendation }))
    };
  }

  function App(){
    const [rawInput, setRawInput] = useState('');
    const [rows, setRows] = useState([]);
    const [report, setReport] = useState(null);
    const [name, setName] = useState('NAC Auto-Audit');

    function handlePasteSample(){
      const sample = `date,employee,amount,invoice,requested_by,approved_by,issue_date,acquitted_date\n2025-10-01,John Doe,120.00,INV-1001,John Doe,Alice,2025-10-01,2025-10-20\n2025-10-05,Jane Smith,45.50,INV-1002,Jane Smith,Bob,2025-10-05,2025-10-12\n2025-10-07,Mary Tan,5000,INV-1003,Mary Tan,Mary Tan,2025-10-07,2025-10-30`;
      setRawInput(sample);
      setRows(parseCSV(sample));
    }

    function handleFile(e){
      const f = e.target.files?.[0];
      if (!f) return;
      const reader = new FileReader();
      reader.onload = (ev) => {
        const text = ev.target.result;
        setRawInput(text);
        setRows(parseCSV(text));
      };
      reader.readAsText(f);
    }

    function handleParse(){
      setRows(parseCSV(rawInput));
      setReport(null);
    }

    function handleRun(){
      const data = rows.length ? rows : parseCSV(rawInput || '');
      setRows(data);
      const res = runAudit(data, name);
      setReport(res);
    }

    function downloadJSON(){
      const dataStr = `data:text/json;charset=utf-8,${encodeURIComponent(JSON.stringify(report, null, 2))}`;
      const dl = document.createElement('a');
      dl.setAttribute('href', dataStr);
      dl.setAttribute('download', `${name.replace(/\s+/g,'_')}_audit_report.json`);
      document.body.appendChild(dl);
      dl.click();
      dl.remove();
    }

    return (
      <div>
        <header className="flex items-center justify-between mb-6">
          <h1 className="text-2xl font-bold">{name}</h1>
          <div className="text-sm text-slate-600">Internal Auditor AI — Website (MVP)</div>
        </header>

        <main className="grid grid-cols-1 md:grid-cols-3 gap-6">
          <section className="md:col-span-1 bg-white p-4 rounded-lg shadow-sm">
            <h2 className="font-semibold mb-2">Upload / Paste Data</h2>
            <p className="text-sm text-slate-600 mb-3">Paste CSV (header row recommended) or upload a CSV file. Use sample to try.</p>
            <input className="mb-3" type="file" accept="text/csv" onChange={handleFile} />
            <textarea value={rawInput} onChange={(e) => setRawInput(e.target.value)} rows={8} className="w-full p-2 border rounded mb-2" placeholder="Paste CSV here"></textarea>
            <div className="flex gap-2">
              <button onClick={handleParse} className="px-3 py-1 bg-slate-800 text-white rounded">Parse CSV</button>
              <button onClick={handlePasteSample} className="px-3 py-1 border rounded">Paste sample</button>
              <button onClick={() => { setRawInput(''); setRows([]); setReport(null); }} className="px-3 py-1 border rounded">Clear</button>
            </div>

            <hr className="my-4" />

            <h3 className="font-semibold mb-2">Quick Controls</h3>
            <label className="block text-sm mb-2">Audit Name</label>
            <input value={name} onChange={(e)=>setName(e.target.value)} className="w-full p-2 border rounded mb-3" />
            <button onClick={handleRun} className="w-full py-2 bg-emerald-600 text-white rounded shadow">Run Audit</button>
          </section>

          <section className="md:col-span-2 bg-white p-4 rounded-lg shadow-sm">
            <h2 className="font-semibold mb-2">Audit Results</h2>

            {!report && (
              <div className="text-sm text-slate-600">No report yet. Run an audit to see findings and recommendations.</div>
            )}

            {report && (
              <div>
                <div className="mb-4 p-3 bg-slate-50 rounded">
                  <div className="flex items-center justify-between">
                    <div>
                      <div className="text-lg font-bold">{report.title}</div>
                      <div className="text-sm text-slate-600">Generated: {new Date(report.generated_at).toLocaleString()}</div>
                      <div className="text-sm text-slate-600">Records analysed: {report.total_records}</div>
                    </div>
                    <div className="text-right">
                      <div className="text-sm">Findings: {report.findings_count}</div>
                      <div className="text-sm">High: {report.severity.High || 0} • Medium: {report.severity.Medium || 0} • Low: {report.severity.Low || 0}</div>
                    </div>
                  </div>
                </div>

                <div className="space-y-3">
                  {report.findings.map((f, i) => (
                    <div key={i} className="p-3 border rounded flex justify-between items-start">
                      <div>
                        <div className="text-sm font-semibold">{f.area} — <span className="text-slate-500">{f.risk}</span></div>
                        <div className="text-sm mt-1">{f.issue}</div>
                        <div className="text-sm mt-2 text-slate-700"><strong>Recommendation:</strong> {f.recommendation}</div>
                      </div>
                      <div className="text-xs text-slate-500">#{i+1}</div>
                    </div>
                  ))}
                </div>

                <div className="mt-4 flex gap-2">
                  <button onClick={() => navigator.clipboard.writeText(JSON.stringify(report, null, 2))} className="px-3 py-1 border rounded">Copy JSON</button>
                  <button onClick={downloadJSON} className="px-3 py-1 border rounded">Download JSON</button>
                </div>

                <hr className="my-4" />

                <h3 className="font-semibold">Suggested Follow-up Plan</h3>
                <ul className="list-disc pl-5 mt-2 text-sm text-slate-700">
                  <li>Assign owner to address high-risk findings within 30 days.</li>
                  <li>Implement receipt upload requirement for all transactions.</li>
                  <li>Configure automated reminders for acquittals after 7 days.</li>
                  <li>Conduct manual review of duplicate invoice numbers and outliers.</li>
                </ul>

              </div>
            )}

            <hr className="my-4" />

            <h3 className="font-semibold">Preview Data (first 10 rows)</h3>
            <div className="mt-2 overflow-auto max-h-56">
              <table className="min-w-full text-sm border-collapse">
                <thead className="bg-slate-100 sticky top-0">
                  <tr>
                    {rows[0] ? Object.keys(rows[0]).slice(0,10).map((h,i)=>(<th key={i} className="px-2 py-1 text-left border">{h}</th>)) : <th className="px-2 py-1">(no data)</th>}
                  </tr>
                </thead>
                <tbody>
                  {rows.slice(0,10).map((r,ri)=>(
                    <tr key={ri} className="odd:bg-white even:bg-slate-50">
                      {Object.keys(r).slice(0,10).map((k,ki)=>(<td key={ki} className="px-2 py-1 border">{r[k]}</td>))}
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>

          </section>
        </main>

        <footer className="mt-8 text-sm text-slate-600">
          <div>Notes: This is an MVP rule-based auditor that runs entirely in the browser. To make it production-ready: add secure storage, authentication, scheduled audits, and integrations with NAC systems (ACCPAC/SAP). To add LLM-powered narrative reports, connect to a backend that calls an LLM securely.</div>
        </footer>
      </div>
    );
  }

  ReactDOM.createRoot(document.getElementById('root')).render(<App />);
</script>

  </body>
</html>
