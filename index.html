<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>NAC Internal Auditor AI</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
  :root {
    --nac-blue: #1D4ED8;
    --nac-green: #10B981;
  }
</style>
</head>
<body class="bg-slate-50 min-h-screen font-sans">

<!-- Login Page -->
<div id="loginPage" class="flex flex-col items-center justify-center min-h-screen p-6">
  <div class="bg-white p-6 rounded shadow-md w-full max-w-sm">
    <h1 class="text-2xl font-bold text-center mb-4" style="color: var(--nac-blue)">NAC Internal Auditor AI</h1>
    <input id="username" placeholder="Username" class="w-full p-2 mb-2 border rounded">
    <input id="password" placeholder="Password" type="password" class="w-full p-2 mb-4 border rounded">
    <button id="loginBtn" class="w-full py-2 bg-emerald-600 text-white rounded">Login</button>
  </div>
</div>

<!-- Dashboard -->
<div id="dashboard" class="hidden max-w-5xl mx-auto p-6">
  <header class="flex items-center justify-between mb-6">
    <h1 class="text-2xl font-bold" style="color: var(--nac-blue)">NAC Internal Auditor AI</h1>
    <div>
      <button id="logoutBtn" class="px-3 py-1 border rounded bg-slate-200">Logout</button>
    </div>
  </header>

  <main class="grid grid-cols-1 md:grid-cols-2 gap-6">
    <!-- Input Section -->
    <section class="bg-white p-4 rounded-lg shadow-sm">
      <h2 class="font-semibold mb-2">Paste or Upload CSV Data</h2>
      <input type="file" id="csvFile" accept=".csv,text/csv" class="mb-2 w-full p-2 border rounded">
      <textarea id="csvInput" rows="6" class="w-full p-2 border rounded mb-2" placeholder="Or paste CSV here"></textarea>
      <button id="runAudit" class="w-full py-2 bg-emerald-600 text-white rounded shadow">Run Audit</button>
      <button id="pasteSample" class="w-full mt-2 py-2 border rounded">Paste Sample CSV</button>
      <div id="tablePreview" class="mt-4 overflow-auto max-h-48 border rounded bg-slate-50 p-2 text-sm"></div>
    </section>

    <!-- Audit Summary Section -->
    <section class="bg-white p-4 rounded-lg shadow-sm">
      <h2 class="font-semibold mb-2">Audit Summary</h2>
      <div id="summaryBox" class="mt-3 text-sm text-slate-700"></div>
      <canvas id="summaryChart" class="mt-4 w-full" height="200"></canvas>
      <div class="mt-4">
        <strong>Fraud Score:</strong> <span id="fraudScore">0%</span>
      </div>
    </section>
  </main>

  <!-- Audit Results Section -->
  <section class="bg-white p-4 rounded-lg shadow-sm mt-6">
    <h2 class="font-semibold mb-2">Audit Results</h2>
    <div id="results" class="text-sm text-slate-600">No report yet.</div>
    <div class="mt-4 flex gap-2 flex-wrap">
      <button id="downloadJSON" class="px-3 py-2 border rounded bg-slate-200">Download JSON</button>
      <button id="downloadExcel" class="px-3 py-2 border rounded bg-slate-200">Download Excel</button>
      <button id="downloadPDF" class="px-3 py-2 border rounded bg-slate-200">Download PDF</button>
      <button id="saveReport" class="px-3 py-2 border rounded bg-green-400 text-white">Save Report</button>
      <button id="loadReport" class="px-3 py-2 border rounded bg-blue-400 text-white">Load Last Report</button>
    </div>
  </section>
</div>

<script>
let lastReport = [];
let chartInstance = null;

// ===== Login =====
const loginPage = document.getElementById('loginPage');
const dashboard = document.getElementById('dashboard');

function checkLogin() {
  const logged = localStorage.getItem('nac_logged');
  if(logged){
    loginPage.classList.add('hidden');
    dashboard.classList.remove('hidden');
  } else {
    loginPage.classList.remove('hidden');
    dashboard.classList.add('hidden');
  }
}

document.getElementById('loginBtn').addEventListener('click', ()=>{
  const u = document.getElementById('username').value.trim();
  const p = document.getElementById('password').value.trim();
  if(!u || !p) return alert('Enter username/password');
  localStorage.setItem('nac_logged', u);
  checkLogin();
});

document.getElementById('logoutBtn').addEventListener('click', ()=>{
  localStorage.removeItem('nac_logged');
  checkLogin();
});

checkLogin();

// ===== CSV Parser =====
function parseCSV(text){
  const lines = text.split(/\r?\n/).filter(l=>l.trim());
  if(!lines.length) return { headers: [], data: [] };
  const headers = lines[0].split(',').map(h=>h.trim());
  const data = lines.slice(1).map(line=>{
    const parts = line.split(',').map(p=>p.trim());
    const obj = {};
    headers.forEach((h,i)=> obj[h]=parts[i]||"");
    return obj;
  });
  return { headers, data };
}

// ===== Audit Logic =====
function runAudit(parsed){
  const dataRows = parsed.data;
  const headers = parsed.headers;

  const invoiceKey = headers.find(h=>h.toLowerCase().includes("invoice")||h.toLowerCase().includes("receipt"));
  const dateKey = headers.find(h=>h.toLowerCase().includes("date"));
  const amountKey = headers.find(h=>h.toLowerCase().includes("amount")||h.toLowerCase().includes("total")||h.toLowerCase().includes("value"));
  const requestedKey = headers.find(h=>h.toLowerCase().includes("requested"));
  const approvedKey = headers.find(h=>h.toLowerCase().includes("approved"));

  let missingDates=0, missingAmounts=0, missingInvoices=0;
  const seen = {};
  const duplicates = new Set();
  const amountValues = [];
  const approvalAnomalies = [];

  dataRows.forEach(r=>{
    if(dateKey && !r[dateKey].trim()) missingDates++;
    if(amountKey && !r[amountKey].trim()) missingAmounts++;
    if(invoiceKey && !r[invoiceKey].trim()) missingInvoices++;

    if(invoiceKey){
      const inv = r[invoiceKey].trim();
      if(inv){
        if(seen[inv]) duplicates.add(inv);
        seen[inv]=true;
      }
    }

    if(amountKey && r[amountKey].trim()){
      const val = parseFloat(r[amountKey]);
      if(!isNaN(val)) amountValues.push(val);
    }

    if(requestedKey && approvedKey && r[requestedKey].trim() && r[approvedKey].trim() && r[requestedKey].trim()===r[approvedKey].trim()){
      approvalAnomalies.push(r);
    }
  });

  // Outlier detection (1.5*IQR)
  let outlierCount=0;
  if(amountValues.length){
    amountValues.sort((a,b)=>a-b);
    const q1 = amountValues[Math.floor(amountValues.length*0.25)];
    const q3 = amountValues[Math.floor(amountValues.length*0.75)];
    const iqr = q3-q1;
    const lower = q1-1.5*iqr;
    const upper = q3+1.5*iqr;
    dataRows.forEach(r=>{
      if(amountKey && r[amountKey].trim()){
        const val = parseFloat(r[amountKey]);
        if(!isNaN(val) && (val<lower || val>upper)) outlierCount++;
      }
    });
  }

  // Compile findings
  const findings=[];
  if(!dateKey) findings.push("No date column found.");
  if(!amountKey) findings.push("No amount column found.");
  if(!invoiceKey) findings.push("No invoice column found.");
  if(missingDates) findings.push(`${missingDates} missing dates detected.`);
  if(missingAmounts) findings.push(`${missingAmounts} missing amounts detected.`);
  if(missingInvoices) findings.push(`${missingInvoices} missing invoices detected.`);
  if(duplicates.size) findings.push(`${duplicates.size} duplicate invoices detected.`);
  if(outlierCount) findings.push(`${outlierCount} amount outliers detected.`);
  if(approvalAnomalies.length) findings.push(`${approvalAnomalies.length} approval anomalies detected.`);
  if(!findings.length) findings.push("No issues detected.");

  // Fraud score
  const fraudScore = Math.min(100,
    missingDates*5 +
    missingAmounts*5 +
    missingInvoices*5 +
    duplicates.size*10 +
    outlierCount*10 +
    approvalAnomalies.length*10
  );
  document.getElementById('fraudScore').innerText = fraudScore + "%";

  // Update dashboard
  updateSummaryDashboard({
    total: dataRows.length,
    missingDates,
    missingAmounts,
    missingInvoices,
    duplicates: duplicates.size,
    outliers: outlierCount,
    approvalAnomalies: approvalAnomalies.length
  });

  lastReport = findings;
  return findings;
}

// ===== Table Preview =====
function showTablePreview(parsed){
  if(!parsed.data.length) return document.getElementById("tablePreview").innerHTML="No data to preview.";
  const headers = parsed.headers;
  const rows = parsed.data.slice(0,10);
  let html="<table class='w-full border-collapse'><thead class='bg-slate-200'><tr>";
  headers.forEach(h=>html+=`<th class='border px-2 py-1 text-left'>${h}</th>`);
  html+="</tr></thead><tbody>";
  rows.forEach(r=>{
    html+="<tr class='odd:bg-white even:bg-slate-50'>";
    headers.forEach(h=>html+=`<td class='border px-2 py-1'>${r[h]}</td>`);
    html+="</tr>";
  });
  html+="</tbody></table>";
  document.getElementById("tablePreview").innerHTML=html;
}

// ===== Summary Dashboard =====
function updateSummaryDashboard(stats){
  const box=document.getElementById('summaryBox');
  box.innerHTML=`
    <div>Total Rows: <strong>${stats.total}</strong></div>
    <div>Missing Dates: <strong>${stats.missingDates}</strong></div>
    <div>Missing Amounts: <strong>${stats.missingAmounts}</strong></div>
    <div>Missing Invoices: <strong>${stats.missingInvoices}</strong></div>
    <div>Duplicate Invoices: <strong>${stats.duplicates}</strong></div>
    <div>Amount Outliers: <strong>${stats.outliers}</strong></div>
    <div>Approval Anomalies: <strong>${stats.approvalAnomalies}</strong></div>
  `;
  const ctx=document.getElementById('summaryChart').getContext('2d');
  if(chartInstance) chartInstance.destroy();
  chartInstance=new Chart(ctx,{
    type:"bar",
    data:{
      labels:["Missing Dates","Missing Amounts","Missing Invoices","Duplicates","Outliers","Approval Anomalies"],
      datasets:[{
        label:"Issues Found",
        data:[stats.missingDates, stats.missingAmounts, stats.missingInvoices, stats.duplicates, stats.outliers, stats.approvalAnomalies],
        backgroundColor:['#F87171','#FBBF24','#60A5FA','#34D399','#A78BFA','#F472B6']
      }]
    }
  });
}

// ===== Event Listeners =====
function processCSV(csvText){
  const parsed=parseCSV(csvText);
  showTablePreview(parsed);
  const results=runAudit(parsed);
  document.getElementById('results').innerHTML=results.map(r=>`<div class="p-2 border-b">${r}</div>`).join('');
}

document.getElementById('runAudit').addEventListener('click', ()=>{
  let csvText=document.getElementById('csvInput').value;
  const fileInput=document.getElementById('csvFile');
  if(fileInput.files.length){
    const reader=new FileReader();
    reader.onload=(e)=>{
      processCSV(e.target.result);
    };
    reader.readAsText(fileInput.files[0]);
  } else if(csvText) processCSV(csvText);
  else alert("Paste CSV or upload a CSV file first.");
});

document.getElementById('pasteSample').addEventListener('click', ()=>{
  const sample=`date,employee,amount,invoice,requested_by,approved_by
2025-10-01,John Doe,120.00,INV-1001,John Doe,Alice
2025-10-05,Jane Smith,45.50,INV-1002,Jane Smith,Bob
2025-10-07,Mary Tan,5000,INV-1003,Mary Tan,Mary Tan`;
  document.getElementById('csvInput').value=sample;
  processCSV(sample);
});

// ===== Export JSON =====
document.getElementById('downloadJSON').addEventListener('click', ()=>{
  if(!lastReport.length) return alert("Run audit first.");
  const dataStr="data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(lastReport,null,2));
  const dl=document.createElement('a');
  dl.href=dataStr; dl.download="audit_report.json"; document.body.appendChild(dl); dl.click(); dl.remove();
});

// ===== Export Excel =====
document.getElementById('downloadExcel').addEventListener('click', ()=>{
  if(!lastReport.length) return alert("Run audit first.");
  const ws=XLSX.utils.json_to_sheet(lastReport.map((v,i)=>({No:i+1, Issue:v})));
  const wb=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "AuditReport");
  XLSX.writeFile(wb,"audit_report.xlsx");
});

// ===== Export PDF =====
document.getElementById('downloadPDF').addEventListener('click', ()=>{
  if(!lastReport.length) return alert("Run audit first.");
  const { jsPDF }=window.jspdf;
  const doc=new jsPDF();
  doc.setFontSize(12);
  doc.text("Internal Audit Report",10,10);
  lastReport.forEach((r,i)=>doc.text(`${i+1}. ${r}`,10,20+i*10));
  doc.save("audit_report.pdf");
});

// ===== Save/Load Local Report =====
document.getElementById('saveReport').addEventListener('click', ()=>{
  if(!lastReport.length) return alert("Run audit first.");
  localStorage.setItem('nac_last_report', JSON.stringify(lastReport));
  alert("Report saved locally!");
});

document.getElementById('loadReport').addEventListener('click', ()=>{
  const saved=localStorage.getItem('nac_last_report');
  if(!saved) return alert("No saved report found.");
  lastReport=JSON.parse(saved);
  document.getElementById('results').innerHTML=lastReport.map(r=>`<div class="p-2 border-b">${r}</div>`).join('');
  alert("Last report loaded!");
});
</script>

</body>
</html>
