<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>NAC Internal Auditor AI</title>

<!-- Tailwind -->
<script src="https://cdn.tailwindcss.com"></script>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- SheetJS (Excel parser) -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<!-- jsPDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
body {
  background:#f1f5f9;
}
</style>
</head>

<body class="p-4">

<div class="max-w-6xl mx-auto">
  
  <!-- Header -->
  <header class="mb-6">
    <h1 class="text-3xl font-bold">NAC Internal Auditor AI</h1>
    <p class="text-slate-600 text-sm">Automated Internal Audit Engine (Excel + CSV)</p>
  </header>

  <!-- Layout -->
  <div class="grid grid-cols-1 md:grid-cols-2 gap-4">

    <!-- LEFT SIDE -->
    <div class="bg-white shadow rounded p-4">
      <h2 class="font-semibold mb-3">Upload or Paste Data</h2>

      <input id="fileInput" type="file"
        accept=".csv, text/csv, .xlsx, .xls"
        class="w-full mb-3 border rounded p-2" />

      <textarea id="csvInput" rows="6"
        class="w-full border rounded p-2 mb-3"
        placeholder="Or paste CSV here..."></textarea>

      <button id="runAudit" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white p-2 rounded">
        Run Audit
      </button>

      <button id="pasteSample" class="mt-3 w-full border p-2 rounded">
        Paste Sample CSV
      </button>

      <h3 class="mt-5 font-semibold">Table Preview</h3>
      <div id="tablePreview" class="overflow-auto max-h-64 text-sm border rounded bg-slate-50 p-2"></div>
    </div>

    <!-- RIGHT SIDE -->
    <div class="bg-white shadow rounded p-4">
      <h2 class="font-semibold mb-3">Audit Results</h2>

      <!-- Search + Filter -->
      <div class="flex gap-2 mb-3">
        <input id="searchInput" class="flex-1 border rounded p-2 text-sm" placeholder="Search..." />
        <select id="riskFilter" class="border rounded p-2 text-sm">
          <option value="all">All Risks</option>
          <option value="high">High Risk</option>
          <option value="medium">Medium Risk</option>
          <option value="low">Low Risk</option>
        </select>
      </div>

      <!-- Results -->
      <div id="results" class="text-sm min-h-[120px] border rounded p-2 bg-slate-50">
        No report yet.
      </div>

      <!-- Pagination -->
      <div class="flex justify-between mt-3">
        <button id="prevPage" class="px-3 py-1 border rounded">Prev</button>
        <div id="pageNumber" class="text-sm text-slate-500"></div>
        <button id="nextPage" class="px-3 py-1 border rounded">Next</button>
      </div>

      <!-- Download Buttons -->
      <div class="mt-4 flex gap-3">
        <button id="downloadJSON" class="flex-1 border p-2 rounded bg-slate-200">Download JSON</button>
        <button id="downloadPDF" class="flex-1 border p-2 rounded bg-slate-200">Download PDF</button>
      </div>

      <!-- Summary -->
      <h3 class="mt-6 font-semibold">Summary Dashboard</h3>
      <div id="summaryBox" class="text-sm text-slate-700 mt-2"></div>
      <canvas id="summaryChart" class="mt-4" height="200"></canvas>
    </div>

  </div>
</div>

<!-- ===========================
       JAVASCRIPT SECTION
=========================== -->

<script>
let globalParsed = { headers: [], data: [] };
let lastReport = [];
let pagedReport = [];
let currentPage = 1;
let rowsPerPage = 6;
let currentSearch = "";
let currentRisk = "all";
let chartInstance = null;

function parseCSV(txt) {
  const lines = txt.split(/\r?\n/).filter(l=>l.trim());
  if (!lines.length) return {headers:[],data:[]};

  const headers = lines[0].split(",").map(h=>h.trim());
  const data = lines.slice(1).map(line=>{
    const cells = line.split(",").map(c=>c.trim());
    let row = {};
    headers.forEach((h,i)=>row[h] = cells[i] ?? "");
    return row;
  });

  return {headers,data};
}

function parseExcelFile(file){
  return new Promise((resolve)=>{
    const reader=new FileReader();
    reader.onload=(e)=>{
      const workbook=XLSX.read(new Uint8Array(e.target.result),{type:"array"});
      const sheet=workbook.Sheets[workbook.SheetNames[0]];
      const json = XLSX.utils.sheet_to_json(sheet,{defval:""});
      resolve({ headers: Object.keys(json[0]||{}), data: json });
    };
    reader.readAsArrayBuffer(file);
  });
}

function runAudit(parsed){
  const data = parsed.data;
  const hdr = parsed.headers.map(h=>h.toLowerCase());

  const dateKey = parsed.headers.find(h=>h.toLowerCase().includes("date"));
  const amtKey = parsed.headers.find(h=>h.toLowerCase().includes("amount"));
  const invKey = parsed.headers.find(h=>h.toLowerCase().includes("invoice")||h.toLowerCase().includes("receipt"));

  let missingDate=0, missingAmt=0, missingInv=0;

  const seen={};
  const duplicates=new Set();

  data.forEach(r=>{
    if(dateKey && !r[dateKey]) missingDate++;
    if(amtKey && !r[amtKey]) missingAmt++;
    if(invKey && !r[invKey]) missingInv++;

    if(invKey){
      const v=r[invKey];
      if(v){
        if(seen[v]) duplicates.add(v);
        seen[v]=true;
      }
    }
  });

  lastReport = data.map((r,i)=>{
    let risk="low";
    if(!r[dateKey] || !r[amtKey] || !r[invKey]) risk="medium";
    if(duplicates.has(r[invKey])) risk="high";

    return {
      row:i+1,
      risk,
      message:
        risk=="high" ? "Duplicate invoice detected" :
        risk=="medium" ? "Missing key financial field" :
        "OK",
      record:r
    };
  });

  updateDashboard({
    total:data.length,
    missingDate,
    missingAmt,
    missingInv,
    duplicates:duplicates.size
  });

  refreshView();
}

function refreshView(){
  let filtered = lastReport;

  if(currentSearch){
    filtered = filtered.filter(r=>JSON.stringify(r.record).toLowerCase().includes(currentSearch));
  }

  if(currentRisk!="all"){
    filtered = filtered.filter(r=>r.risk===currentRisk);
  }

  const totalPages = Math.max(1, Math.ceil(filtered.length / rowsPerPage));
  if(currentPage>totalPages) currentPage=totalPages;

  const start=(currentPage-1)*rowsPerPage;
  pagedReport = filtered.slice(start,start+rowsPerPage);

  const box = document.getElementById("results");
  box.innerHTML = pagedReport.map(r=>`
    <div class="border-b p-2 ${r.risk=='high'?'bg-red-100':r.risk=='medium'?'bg-yellow-100':'bg-green-100'}">
      <strong>Row ${r.row}</strong> â€” ${r.message}<br>
      <span class="text-xs">${JSON.stringify(r.record)}</span>
    </div>
  `).join("");

  document.getElementById("pageNumber").innerText =
    `Page ${currentPage} of ${Math.max(1, totalPages)}`;
}

function updateDashboard(stats){
  const box = document.getElementById("summaryBox");
  box.innerHTML = `
    <div>Total Rows: <strong>${stats.total}</strong></div>
    <div>Missing Dates: <strong>${stats.missingDate}</strong></div>
    <div>Missing Amounts: <strong>${stats.missingAmt}</strong></div>
    <div>Missing Invoices: <strong>${stats.missingInv}</strong></div>
    <div>Duplicate Invoices: <strong>${stats.duplicates}</strong></div>
  `;

  const ctx = document.getElementById("summaryChart");
  if(chartInstance) chartInstance.destroy();

  chartInstance = new Chart(ctx,{
    type:"bar",
    data:{
      labels:["Missing Dates","Missing Amounts","Missing Invoices","Duplicates"],
      datasets:[{
        label:"Issues",
        data:[
          stats.missingDate,
          stats.missingAmt,
          stats.missingInv,
          stats.duplicates
        ]
      }]
    }
  });
}

document.getElementById("runAudit").onclick=()=>{
  const file=document.getElementById("fileInput").files[0];
  let text=document.getElementById("csvInput").value.trim();

  if(file){
    const name=file.name.toLowerCase();
    if(name.endsWith(".xlsx")||name.endsWith(".xls")){
      parseExcelFile(file).then(p=>{
        globalParsed=p;
        runAudit(p);
      });
    } else {
      const reader=new FileReader();
      reader.onload=e=>{
        const p=parseCSV(e.target.result);
        globalParsed=p;
        runAudit(p);
      };
      reader.readAsText(file);
    }
    return;
  }

  if(text){
    const parsed=parseCSV(text);
    globalParsed=parsed;
    runAudit(parsed);
    return;
  }

  alert("Upload a file or paste CSV first.");
};

document.getElementById("pasteSample").onclick=()=>{
  const s = `date,employee,amount,invoice
2025-01-01,John,100,INV-1
2025-01-02,Mary,300,INV-1
2025-01-03,Peter,,INV-3`;
  document.getElementById("csvInput").value=s;
};

document.getElementById("searchInput").oninput=(e)=>{
  currentSearch=e.target.value.toLowerCase();
  refreshView();
};

document.getElementById("riskFilter").onchange=(e)=>{
  currentRisk=e.target.value;
  refreshView();
};

document.getElementById("prevPage").onclick=()=>{
  if(currentPage>1){currentPage--;refreshView();}
};

document.getElementById("nextPage").onclick=()=>{
  currentPage++;refreshView();
};

document.getElementById("downloadJSON").onclick=()=>{
  if(!lastReport.length) return alert("Run audit first");
  const str="data:text/json,"+encodeURIComponent(JSON.stringify(lastReport,null,2));
  const a=document.createElement("a");
  a.href=str;
  a.download="audit_report.json";
  a.click();
};

document.getElementById("downloadPDF").onclick=()=>{
  if(!lastReport.length) return alert("Run audit first");

  const { jsPDF } = window.jspdf;
  const doc=new jsPDF();

  doc.text("Internal Audit Report",10,10);

  lastReport.forEach((r,i)=>{
    doc.text(`${i+1}. [${r.risk.toUpperCase()}] ${r.message}`,10,20+i*8);
  });

  doc.save("audit_report.pdf");
};

</script>
</body>
</html>
